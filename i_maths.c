#include <stdio.h>
#include <math.h>
#include "i_maths.h"

__extension__ int i_sqrt(long long x)
{
	return (int)floor(sqrt(x) + 0.5);
}


int i_atan2(long y, long x)
{
#if 0
	int rotate = 0;
	int y2;

	if ((x | y) == 0) return 0;
	if (y < 0) { rotate += -32768; y = -y, x = -x; }
	if (x < 0) { rotate += 16384; y2 = y; y = -x; x = y2; }
	if (y > x) { rotate += 8192; y2 = y; y -= x; x += y2; }
	if (2 * y > x)
	{
		rotate += 4836;	/* atan(1/2) * 32768/M_PI */
		y2 = y;
		y = 2 * y - x;
		x = 2 * x + y2;
	}
#if 1
	if (4 * y > x)
	{
		rotate += 2555;	/* atan(1/4) * 32768/M_PI */
		y2 = y;
		y = 4 * y - x;
		x = 4 * x + y2;
	}
#if 1
	if (8 * y > x)
	{
		rotate += 1297;	/* atan(1/8) * 32768/M_PI */
		y2 = y;
		y = 8 * y - x;
		x = 8 * x + y2;
	}
#if 1
	if (16 * y > x)
	{
		rotate += 651;	/* atan(1/16) * 32768/M_PI */
		y2 = y;
		y = 16 * y - x;
		x = 16 * x + y2;
	}
#if 0
	if (32 * y > x)
	{
		rotate += 326;	/* atan(1/32) * 32768/M_PI */
		y2 = y;
		y = 32 * y - x;
		x = 32 * x + y2;
	}
	return rotate + 10427 * y / x;	/* up to atan(1/32) */
#else
	return rotate + 10417 * y / x;	/* up to atan(1/16) */
#endif
#else
	return rotate + 10377 * y / x;	/* up to atan(1/8) */
#endif
#else
	return rotate + 10221 * y / x;	/* up to atan(1/4) */
#endif
#else
	return rotate + 9672 * y / x;	/* up to atan(1/2) */
#endif
#else
	return (int)floor(atan2(y, x) * (DEG_180 / M_PI) + 0.5);
#endif
}


void i_sincos(long *sinptr, long *cosptr, int theta)
{
#if 1
	if (sinptr != NULL) *sinptr = (long)floor(sin(theta * (M_PI / DEG_180)) * SIN_SCALE + 0.5);
	if (cosptr != NULL) *cosptr = (long)floor(cos(theta * (M_PI / DEG_180)) * SIN_SCALE + 0.5);
#else
	static const signed int bigsintab[1025] =
	{
		     0,    402,    804,   1206,   1608,   2010,   2412,   2814,   3216,   3617,   4019,   4420,   4821,   5222,   5623,   6023,
		  6424,   6824,   7224,   7623,   8022,   8421,   8820,   9218,   9616,  10014,  10411,  10808,  11204,  11600,  11996,  12391,
		 12785,  13180,  13573,  13966,  14359,  14751,  15143,  15534,  15924,  16314,  16703,  17091,  17479,  17867,  18253,  18639,
		 19024,  19409,  19792,  20175,  20557,  20939,  21320,  21699,  22078,  22457,  22834,  23210,  23586,  23961,  24335,  24708,
		 25080,  25451,  25821,  26190,  26558,  26925,  27291,  27656,  28020,  28383,  28745,  29106,  29466,  29824,  30182,  30538,
		 30893,  31248,  31600,  31952,  32303,  32652,  33000,  33347,  33692,  34037,  34380,  34721,  35062,  35401,  35738,  36075,
		 36410,  36744,  37076,  37407,  37736,  38064,  38391,  38716,  39040,  39362,  39683,  40002,  40320,  40636,  40951,  41264,
		 41576,  41886,  42194,  42501,  42806,  43110,  43412,  43713,  44011,  44308,  44604,  44898,  45190,  45480,  45769,  46056,
		 46341,  46624,  46906,  47186,  47464,  47741,  48015,  48288,  48559,  48828,  49095,  49361,  49624,  49886,  50146,  50404,
		 50660,  50914,  51166,  51417,  51665,  51911,  52156,  52398,  52639,  52878,  53114,  53349,  53581,  53812,  54040,  54267,
		 54491,  54714,  54934,  55152,  55368,  55582,  55794,  56004,  56212,  56418,  56621,  56823,  57022,  57219,  57414,  57607,
		 57798,  57986,  58172,  58356,  58538,  58718,  58896,  59071,  59244,  59415,  59583,  59750,  59914,  60075,  60235,  60392,
		 60547,  60700,  60851,  60999,  61145,  61288,  61429,  61568,  61705,  61839,  61971,  62101,  62228,  62353,  62476,  62596,
		 62714,  62830,  62943,  63054,  63162,  63268,  63372,  63473,  63572,  63668,  63763,  63854,  63944,  64031,  64115,  64197,
		 64277,  64354,  64429,  64501,  64571,  64639,  64704,  64766,  64827,  64884,  64940,  64993,  65043,  65091,  65137,  65180,
		 65220,  65259,  65294,  65328,  65358,  65387,  65413,  65436,  65457,  65476,  65492,  65505,  65516,  65525,  65531,  65535,
		 65536,  65535,  65531,  65525,  65516,  65505,  65492,  65476,  65457,  65436,  65413,  65387,  65358,  65328,  65294,  65259,
		 65220,  65180,  65137,  65091,  65043,  64993,  64940,  64884,  64827,  64766,  64704,  64639,  64571,  64501,  64429,  64354,
		 64277,  64197,  64115,  64031,  63944,  63854,  63763,  63668,  63572,  63473,  63372,  63268,  63162,  63054,  62943,  62830,
		 62714,  62596,  62476,  62353,  62228,  62101,  61971,  61839,  61705,  61568,  61429,  61288,  61145,  60999,  60851,  60700,
		 60547,  60392,  60235,  60075,  59914,  59750,  59583,  59415,  59244,  59071,  58896,  58718,  58538,  58356,  58172,  57986,
		 57798,  57607,  57414,  57219,  57022,  56823,  56621,  56418,  56212,  56004,  55794,  55582,  55368,  55152,  54934,  54714,
		 54491,  54267,  54040,  53812,  53581,  53349,  53114,  52878,  52639,  52398,  52156,  51911,  51665,  51417,  51166,  50914,
		 50660,  50404,  50146,  49886,  49624,  49361,  49095,  48828,  48559,  48288,  48015,  47741,  47464,  47186,  46906,  46624,
		 46341,  46056,  45769,  45480,  45190,  44898,  44604,  44308,  44011,  43713,  43412,  43110,  42806,  42501,  42194,  41886,
		 41576,  41264,  40951,  40636,  40320,  40002,  39683,  39362,  39040,  38716,  38391,  38064,  37736,  37407,  37076,  36744,
		 36410,  36075,  35738,  35401,  35062,  34721,  34380,  34037,  33692,  33347,  33000,  32652,  32303,  31952,  31600,  31248,
		 30893,  30538,  30182,  29824,  29466,  29106,  28745,  28383,  28020,  27656,  27291,  26925,  26558,  26190,  25821,  25451,
		 25080,  24708,  24335,  23961,  23586,  23210,  22834,  22457,  22078,  21699,  21320,  20939,  20557,  20175,  19792,  19409,
		 19024,  18639,  18253,  17867,  17479,  17091,  16703,  16314,  15924,  15534,  15143,  14751,  14359,  13966,  13573,  13180,
		 12785,  12391,  11996,  11600,  11204,  10808,  10411,  10014,   9616,   9218,   8820,   8421,   8022,   7623,   7224,   6824,
		  6424,   6023,   5623,   5222,   4821,   4420,   4019,   3617,   3216,   2814,   2412,   2010,   1608,   1206,    804,    402,
		     0,   -402,   -804,  -1206,  -1608,  -2010,  -2412,  -2814,  -3216,  -3617,  -4019,  -4420,  -4821,  -5222,  -5623,  -6023,
		 -6424,  -6824,  -7224,  -7623,  -8022,  -8421,  -8820,  -9218,  -9616, -10014, -10411, -10808, -11204, -11600, -11996, -12391,
		-12785, -13180, -13573, -13966, -14359, -14751, -15143, -15534, -15924, -16314, -16703, -17091, -17479, -17867, -18253, -18639,
		-19024, -19409, -19792, -20175, -20557, -20939, -21320, -21699, -22078, -22457, -22834, -23210, -23586, -23961, -24335, -24708,
		-25080, -25451, -25821, -26190, -26558, -26925, -27291, -27656, -28020, -28383, -28745, -29106, -29466, -29824, -30182, -30538,
		-30893, -31248, -31600, -31952, -32303, -32652, -33000, -33347, -33692, -34037, -34380, -34721, -35062, -35401, -35738, -36075,
		-36410, -36744, -37076, -37407, -37736, -38064, -38391, -38716, -39040, -39362, -39683, -40002, -40320, -40636, -40951, -41264,
		-41576, -41886, -42194, -42501, -42806, -43110, -43412, -43713, -44011, -44308, -44604, -44898, -45190, -45480, -45769, -46056,
		-46341, -46624, -46906, -47186, -47464, -47741, -48015, -48288, -48559, -48828, -49095, -49361, -49624, -49886, -50146, -50404,
		-50660, -50914, -51166, -51417, -51665, -51911, -52156, -52398, -52639, -52878, -53114, -53349, -53581, -53812, -54040, -54267,
		-54491, -54714, -54934, -55152, -55368, -55582, -55794, -56004, -56212, -56418, -56621, -56823, -57022, -57219, -57414, -57607,
		-57798, -57986, -58172, -58356, -58538, -58718, -58896, -59071, -59244, -59415, -59583, -59750, -59914, -60075, -60235, -60392,
		-60547, -60700, -60851, -60999, -61145, -61288, -61429, -61568, -61705, -61839, -61971, -62101, -62228, -62353, -62476, -62596,
		-62714, -62830, -62943, -63054, -63162, -63268, -63372, -63473, -63572, -63668, -63763, -63854, -63944, -64031, -64115, -64197,
		-64277, -64354, -64429, -64501, -64571, -64639, -64704, -64766, -64827, -64884, -64940, -64993, -65043, -65091, -65137, -65180,
		-65220, -65259, -65294, -65328, -65358, -65387, -65413, -65436, -65457, -65476, -65492, -65505, -65516, -65525, -65531, -65535,
		-65536, -65535, -65531, -65525, -65516, -65505, -65492, -65476, -65457, -65436, -65413, -65387, -65358, -65328, -65294, -65259,
		-65220, -65180, -65137, -65091, -65043, -64993, -64940, -64884, -64827, -64766, -64704, -64639, -64571, -64501, -64429, -64354,
		-64277, -64197, -64115, -64031, -63944, -63854, -63763, -63668, -63572, -63473, -63372, -63268, -63162, -63054, -62943, -62830,
		-62714, -62596, -62476, -62353, -62228, -62101, -61971, -61839, -61705, -61568, -61429, -61288, -61145, -60999, -60851, -60700,
		-60547, -60392, -60235, -60075, -59914, -59750, -59583, -59415, -59244, -59071, -58896, -58718, -58538, -58356, -58172, -57986,
		-57798, -57607, -57414, -57219, -57022, -56823, -56621, -56418, -56212, -56004, -55794, -55582, -55368, -55152, -54934, -54714,
		-54491, -54267, -54040, -53812, -53581, -53349, -53114, -52878, -52639, -52398, -52156, -51911, -51665, -51417, -51166, -50914,
		-50660, -50404, -50146, -49886, -49624, -49361, -49095, -48828, -48559, -48288, -48015, -47741, -47464, -47186, -46906, -46624,
		-46341, -46056, -45769, -45480, -45190, -44898, -44604, -44308, -44011, -43713, -43412, -43110, -42806, -42501, -42194, -41886,
		-41576, -41264, -40951, -40636, -40320, -40002, -39683, -39362, -39040, -38716, -38391, -38064, -37736, -37407, -37076, -36744,
		-36410, -36075, -35738, -35401, -35062, -34721, -34380, -34037, -33692, -33347, -33000, -32652, -32303, -31952, -31600, -31248,
		-30893, -30538, -30182, -29824, -29466, -29106, -28745, -28383, -28020, -27656, -27291, -26925, -26558, -26190, -25821, -25451,
		-25080, -24708, -24335, -23961, -23586, -23210, -22834, -22457, -22078, -21699, -21320, -20939, -20557, -20175, -19792, -19409,
		-19024, -18639, -18253, -17867, -17479, -17091, -16703, -16314, -15924, -15534, -15143, -14751, -14359, -13966, -13573, -13180,
		-12785, -12391, -11996, -11600, -11204, -10808, -10411, -10014,  -9616,  -9218,  -8820,  -8421,  -8022,  -7623,  -7224,  -6824,
		 -6424,  -6023,  -5623,  -5222,  -4821,  -4420,  -4019,  -3617,  -3216,  -2814,  -2412,  -2010,  -1608,  -1206,   -804,   -402,
		     0
	};
	int r = theta & 0x7F;
	int i = (theta & 0x1FF80) >> 7;


	if (sinptr != NULL) *sinptr = bigsintab[i] + ((bigsintab[i + 1] - bigsintab[i]) * r >> 7);
	if (cosptr != NULL) i = (i + 256) & 1023, *cosptr = bigsintab[i] + ((bigsintab[i + 1] - bigsintab[i]) * r >> 7);
#endif
}

